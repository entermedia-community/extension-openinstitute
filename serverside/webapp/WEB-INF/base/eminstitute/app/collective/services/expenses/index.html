#set($collectionid = $librarycol.getId())
#set( $catalagDB = $mediaarchive.query("catalogsettings").exact("id", "events_billing_notify_invoice_appid").searchOne() ) 
#set( $db = "entermediadb" ) 
#if ( $catalagDB )
#set( $db = "$catalagDB.value" ) 
#end

<div style="padding:10px 20px;">
              #if( $canviewsettings )
              	#if($mediaarchive.getCatalogSettingValue("productionmode") == "false")
<div class="alert alert-warning"><b>Site is in TEST mode. Add your keys to catalog settings and switch to production mode to take credit cards.</b></div>
#end
                  
                                                   <a
                      href="$applink/collective/services/expenses/addnew.html?collectionid=${collectionid}"
                      class="emdialog btn btn-sm btn-primary mb-4">[[Add Expenses]]</a>
              #end

              #set( $expenses = $mediaarchive.query("collectiveexpense").match("collectionid",$collectionid).sort("createdonDown").search())
              #if ($expenses)
                  <h3>[[Expenses]]</h3>
                  <div class="emdata">
                      <table class="table table-striped">
                          <thead>
                              <tr class="tableheader">
                                  <th>[[Invoice Number]]</th>
                                  <th>[[Due Date]]</th>
                                  <th>[[Paid On]]</th>
                                  <th>[[Name]]</th>
                                  <th>[[Description]]</th>
                                  <th>[[Total Price]]</th>
                                  <th>[[Status]]</th>
                                  <th></th>
                              </tr>
                          </thead>
                          #foreach($hit in $expenses)
                              #if ($hit.instance_status == "active")
                                  #set($instancescount = $instancescount+1)
                              #end
                              <tr>
                                  <td>$hit.invoicenumber</td>
                                  <td>$!context.getDate($hit.duedate)</td>
                                  <td>$!context.getDate($hit.invoicepaidon)</td>
                                  <td>
                                      #set($prods = $hit.getValue("productlist"))
                                      #foreach($pr in $prods)
                                          #set($prod = $mediaarchive.query("collectiveproduct").exact("id", "$pr.productid").searchOne())
                                          $prod<br>
                                      #end
                                  </td>
                                  <td>
                                      #foreach($pr in $prods)
                                          #set($prod = $mediaarchive.query("collectiveproduct").exact("id", "$pr.productid").searchOne())
                                          $!mediaarchive.text($prod.productdescription, $hit.id)<br>
                                      #end
                                  </td>
                                  <td style="text-align: center;">$ $!context.roundDouble($!hit.totalprice, 2)</td>
                        <td>
                            #set($status = $mediaarchive.query("paymentstatus").match("id", "$hit.paymentstatus").searchOne())
                            $status
                        </td>
                        <td>
                            #if( $canviewsettings )
                                <a
                                    href="$siteroot/$db/emshare2/views/settings/lists/datamanager/edit/edit.html?id=$hit.id&searchtype=collectiveinvoice"
                                    class="btn btn-sm btn-secondary"
                                    target="_blank">
                                    <i class="fa fa-database"></i>
                                </a>
                            #end
                            #if ($hit.getValue("paymentstatus") == "invoiced")
                                <a
                                    href="$applink/collective/services/paynow.html?invoiceid=${hit.id}&collectionid=$collectionid"
                                    class="btn btn-sm btn-primary">[[Pay Now]]</a>
                                #elseif ($hit.getValue("paymentstatus") == "autopayfailed" || $hit.getValue("paymentstatus") ==
                                "error")
                                <a
                                    href="$applink/collective/services/paynow.html?invoiceid=${hit.id}&collectionid=$collectionid"
                                    class="btn btn-sm btn-primary">[[Pay Now]]</a>
                                #if ($hit.paymentstatusreason != "")
                                    <div class="alert alert-danger">$hit.paymentstatusreason</div>
                                #end
                            #elseif ($hit.getValue("paymentstatus") == "paid")
                                <a
                                    href="$applink/collective/services/viewinvoice.html?invoiceid=${hit.id}&collectionid=$collectionid"
                                    target="_blank"
                                    class="btn btn-sm btn-secondary">[[View]]</a>
                            #end
                        </td>
                    </tr>
                #end
            </table>
        </div>
    #end
</div>

