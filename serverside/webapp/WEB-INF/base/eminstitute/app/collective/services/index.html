#set($collectionid = $librarycol.getId())
<div id="collectivebilling">
#if($mediaarchive.getCatalogSettingValue("productionmode") != "true")
	<div class="alert alert-warning"><b>Site is in TEST mode. Add your keys to catalog settings and switch to production mode to take credit cards.</b></div>
#end
<div class="collectivecontent" style="margin-bottom:40px;">
	
     #set( $invoices = $mediaarchive.query("collectiveinvoice").match("collectionid",
     $collectionid).sort("createdonDown").search())
     #if ($invoices)
         <h2 style="margin-bottom:10px;">[[Invoices]]</h2>
         <div class="emdata emdatatable">
             <table class="table table-striped table-hover">
                 <thead>
                     <tr class="tableheader">
                         <th style="width: 70px;">[[Invoice]] #</th>
                         <th style="width: 90px;">[[Due Date]]</th>
                         <th style="width: 90px;">[[Paid On]]</th>
                         <th>[[Name]]</th>
                         ##<th>[[Description]]</th>
                         <th>[[Total Price]]</th>
                         <th>[[Status]]</th>
                         <th style="width: 280px;"></th>
                     </tr>
                 </thead>
                 #foreach($hit in $invoices)
                     #if ($hit.instance_status == "active")
                         #set($instancescount = $instancescount+1)
                     #end
                     <tr>
                         <td style="text-align: center;">$hit.invoicenumber</td>
                         <td style="text-align: center;">$!context.getDate($hit.duedate)</td>
                         <td style="text-align: center;">$!context.getDate($hit.invoicepaidon)</td>
                         <td>
                         	#if($hit.getName())
                         	$hit.getName()
                         	#else
	                             #set($prods = $hit.getValue("productlist"))
	                             #foreach($pr in $prods)
	                                 #set($prod = $mediaarchive.query("collectiveproduct").exact("id", "$pr.productid").searchOne())
	                                 $prod<br>
	                             #end
                             #end
                         </td>
                     ##    <td>
                     ##        #foreach($pr in $prods)
                     ##            #set($prod = $mediaarchive.query("collectiveproduct").exact("id", "$pr.productid").searchOne())
                     ##            $!mediaarchive.text($prod.productdescription, $hit.id)<br>
                     ##        #end
                     ##    </td>
                         <td style="text-align: right;">
                         <span class="currencysmall">$!context.getText($!mediaarchive.getCachedData("currencytype", $hit.getValue("currencytype")))</span>
                         $ $!context.doubleToMoney($!hit.totalprice, 2)
                         </td>
                         <td style="text-align: center;">
                             #set($status = $mediaarchive.query("paymentstatus").match("id", "$hit.paymentstatus").searchOne())
                             $!context.getText($status)
                         </td>
                         <td>
                             #if ($hit.getValue("paymentstatus") == "pending")
                             	<a
                                     href="$applink/collective/services/previewinvoice.html?invoiceid=${hit.id}&collectionid=$collectionid"
                                     target="_blank"
                                     class="btn btn-xs btn-secondary emdialog"
                                      data-hidefooter="true">[[Preview]]</a>
                             #elseif ($hit.getValue("paymentstatus") == "paid" || $hit.getValue("paymentstatus") == "invoiced")
                                 <a
                                     href="$applink/collective/services/previewinvoice.html?invoiceid=${hit.id}&collectionid=$collectionid"
                                     target="_blank"
                                     class="btn btn-xs btn-secondary emdialog"
                                      data-hidefooter="true">[[View]]</a>
                             #end
                             #if ($hit.getValue("paymentstatus") == "invoiced")
                                 <a
                                     href="$applink/collective/services/paynow.html?invoiceid=${hit.id}&collectionid=$collectionid"
                                     class="btn btn-xs btn-primary">
                                     [[Pay Now]]</a>
                             #elseif ($hit.getValue("paymentstatus") == "autopayfailed" || $hit.getValue("paymentstatus") == "error")
                                 <a
                                     href="$applink/collective/services/paynow.html?invoiceid=${hit.id}&collectionid=$collectionid"
                                     class="btn btn-xs btn-primary ajax"
                                     data-targetdiv="collectivebilling">[[Pay Now]]</a>
                                 #if ($hit.paymentstatusreason != "")
                                     <div class="alert alert-danger">$hit.paymentstatusreason</div>
                                 #end
							 #end
							 
	                       	 #if( $canviewsettings )
                                 #if ($hit.getValue("paymentstatus") == "pending" ||$hit.getValue("paymentstatus") == "invoiced")
                             	  <a
                                  href="$applink/collective/services/cancelinvoice.html?collectionid=${collectionid}&id=${hit.id}&oemaxlevel=1"
                                  class="ajax btn btn-xs btn-danger" data-targetdiv="collectivebilling">[[Cancel]]</a>
                            	  #end
                            	  <a
                                     href="$sitelink/emshare2/views/settings/lists/datamanager/edit/edit.html?id=$hit.id&searchtype=collectiveinvoice"
                                     class="btn btn-xs btn-secondary"
                                     target="_blank">
                                     <i class="fa fa-database"></i>
                                 </a>
                           	#end
                                   
                               </td>
                           </tr>
                       #end
                   </table>
               </div>
           #end
 </div>
 
 $pages.include("$apphome/collective/services/products/results.html",$context)
 
 </div>