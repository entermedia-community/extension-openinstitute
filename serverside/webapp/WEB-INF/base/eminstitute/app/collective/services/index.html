#set($collectionid = $librarycol.getId())

<div class="collectivecontent" id="collectivebilling">
	<div class="h-100">
	#if( $canviewsettings )
           	#if($mediaarchive.getCatalogSettingValue("productionmode") == "false")
			<div class="alert alert-warning"><b>Site is in TEST mode. Add your keys to catalog settings and switch to production mode to take credit cards.</b></div>
			#end
            <h2>[[Product Catalog]]</h2>
            ##Search instances in these organizations
            #set($products = $mediaarchive.query("collectiveproduct").match("collectionid", $collectionid).sort("createdonDown").search())
            #if ($products)
                <div class="emdata">
                    <table class="table table-striped  table-hover">
                        <thead>
                            <tr class="tableheader">
                                <th style="width: 120px;">[[Created On]]</th>
                             <th>[[Product]]</th>
                             <th>[[Price]]</th>
                             <th style="width: 280px;"></th>
                         </tr>
                     </thead>
                     #foreach($hit in $products)
                         #if ($hit.instance_status == "active")
                             #set($instancescount = $instancescount+1)
                         #end
                         #if($hit.recurring == true || $canviewsettings)
                             <tr>
                                 <td style="text-align: center;">$!context.getDate($hit.createdon)</td>
                                 <td>$hit.name
                                  #if ($hit.billingstatus == "canceled")
                                      &nbsp;<strong>[[Canceled]]</strong>
                                  #end
                                 ##<div style="font-size: 0.9em;">$!mediaarchive.text($hit.productdescription, $hit.id)</div>
                                 </td>
                                 <td style="text-align: right;">
                                 <span class="currencysmall">$!mediaarchive.getCachedData("currencytype", $hit.getValue("currencytype"))</span>
                                 $ $!context.doubleToMoney($!hit.productprice,2)</td>
                                 <td>
                                     #if( $canviewsettings )
                                         <a
                                             href="$sitelink/emshare2/views/settings/lists/datamanager/edit/edit.html?id=$hit.id&searchtype=collectiveproduct"
                                             class="btn btn-xs btn-secondary"
                                             target="_blank">
                                             <i class="fa fa-database"></i>
                                         </a>
                                         <a
                                             href="$applink/collective/services/editproduct.html?collectionid=${collectionid}&id=${hit.id}"
                                             title="[[Edit Product or Service]]"
                                             class="emdialog btn btn-xs btn-info">[[Edit]]</a>
                                         <a
                                             href="$applink/collective/services/copyproduct.html?collectionid=${collectionid}&id=${hit.id}"
                                             title="[[Copy Product or Service]]"
                                             class="emdialog btn btn-xs btn-info">[[Copy]]</a>
                                         
                                         <a
                                             href="$applink/collective/services/generateinvoice.html?collectionid=${collectionid}&id=${hit.id}"
                                             title="[[Invoice Product or Service]]"
                                             class="emdialog btn btn-xs btn-info"
                                             data-hidefooter="true">[[Create Invoice]]</a>
                                     
	                                     #if ($hit.recurring == true)
	                                         #if ($hit.billingstatus == "active")
	                                             #if ($hit.isautopaid == true)
	                                                 <a
	                                                     href="$applink/collective/services/toggleautopay.html?collectionid=${collectionid}&id=${hit.id}"
	                                                     class="btn btn-xs btn-success">[[AutoPay Enabled]]</a>
	                                             #else
	                                                 <a
	                                                     href="$applink/collective/services/toggleautopay.html?collectionid=${collectionid}&id=${hit.id}"
	                                                     class="btn btn-xs btn-secondary">[[AutoPay Paused]]</a>
	                                             #end
	                                         #end
	                                         #if ($hit.billingstatus == "active")
	                                             <a
	                                                 href="$applink/collective/services/cancelsubscription.html?collectionid=${collectionid}&productid=${hit.id}"
	                                                 class="emdialog btn btn-xs btn-danger">[[Cancel]]</a>
	                                         #end
	                                     #end
                                     #end
                                 </td>
                             </tr>
                         #end
                     #end
                 </table>
             </div>
         #end 

         <a
             href="$applink/collective/services/addnew.html?collectionid=${collectionid}"
             class="emdialog btn btn-sm btn-primary mb-4" data-hidefooter="true">[[Add Product or Service]]</a>
     #end

     #set( $invoices = $mediaarchive.query("collectiveinvoice").match("collectionid",
     $collectionid).sort("createdonDown").search())
     #if ($invoices)
         <h2 style="margin-top:30px;">[[Invoices]]</h2>
         <div class="emdata">
             <table class="table table-striped table-hover">
                 <thead>
                     <tr class="tableheader">
                         <th style="width: 70px;">[[Invoice]] #</th>
                         <th style="width: 90px;">[[Due Date]]</th>
                         <th style="width: 90px;">[[Paid On]]</th>
                         <th>[[Name]]</th>
                         ##<th>[[Description]]</th>
                         <th>[[Total Price]]</th>
                         <th>[[Status]]</th>
                         <th style="width: 280px;"></th>
                     </tr>
                 </thead>
                 #foreach($hit in $invoices)
                     #if ($hit.instance_status == "active")
                         #set($instancescount = $instancescount+1)
                     #end
                     <tr>
                         <td style="text-align: center;">$hit.invoicenumber</td>
                         <td style="text-align: center;">$!context.getDate($hit.duedate)</td>
                         <td style="text-align: center;">$!context.getDate($hit.invoicepaidon)</td>
                         <td>
                         	#if($hit.getName())
                         	$hit.getName()
                         	#else
	                             #set($prods = $hit.getValue("productlist"))
	                             #foreach($pr in $prods)
	                                 #set($prod = $mediaarchive.query("collectiveproduct").exact("id", "$pr.productid").searchOne())
	                                 $prod<br>
	                             #end
                             #end
                         </td>
                     ##    <td>
                     ##        #foreach($pr in $prods)
                     ##            #set($prod = $mediaarchive.query("collectiveproduct").exact("id", "$pr.productid").searchOne())
                     ##            $!mediaarchive.text($prod.productdescription, $hit.id)<br>
                     ##        #end
                     ##    </td>
                         <td style="text-align: right;">
                         <span class="currencysmall">$!mediaarchive.getCachedData("currencytype", $hit.getValue("currencytype"))</span>
                         $ $!context.doubleToMoney($!hit.totalprice, 2)
                         </td>
                         <td style="text-align: center;">
                             #set($status = $mediaarchive.query("paymentstatus").match("id", "$hit.paymentstatus").searchOne())
                             $context.getText($status)
                         </td>
                         <td>
                             #if( $canviewsettings )
                                 <a
                                     href="$sitelink/emshare2/views/settings/lists/datamanager/edit/edit.html?id=$hit.id&searchtype=collectiveinvoice"
                                     class="btn btn-xs btn-secondary"
                                     target="_blank">
                                     <i class="fa fa-database"></i>
                                 </a>
                                 #if ($hit.getValue("paymentstatus") == "pending" ||$hit.getValue("paymentstatus") == "invoiced")
                               <a
                                  href="$applink/collective/services/cancelinvoice.html?collectionid=${collectionid}&id=${hit.id}&oemaxlevel=1"
                                  class="ajax btn btn-xs btn-danger" data-targetdiv="collectivebilling">[[Cancel]]</a>
                              #end
                             #end
                             #if ($hit.getValue("paymentstatus") == "pending")
                             	<a
                                     href="$applink/collective/services/previewinvoice.html?invoiceid=${hit.id}&collectionid=$collectionid"
                                     target="_blank"
                                     class="btn btn-xs btn-secondary emdialog"
                                      data-hidefooter="true">[[Preview]]</a>
                             #elseif ($hit.getValue("paymentstatus") == "paid" || $hit.getValue("paymentstatus") == "invoiced")
                                 <a
                                     href="$applink/collective/services/previewinvoice.html?invoiceid=${hit.id}&collectionid=$collectionid"
                                     target="_blank"
                                     class="btn btn-xs btn-secondary emdialog"
                                      data-hidefooter="true">[[View]]</a>
                             #end
                             #if ($hit.getValue("paymentstatus") == "invoiced")
                                 <a
                                     href="$applink/collective/services/paynow.html?invoiceid=${hit.id}&collectionid=$collectionid"
                                     class="btn btn-xs btn-primary">[[Pay Now]]</a>
                             #elseif ($hit.getValue("paymentstatus") == "autopayfailed" || $hit.getValue("paymentstatus") == "error")
                                 <a
                                     href="$applink/collective/services/paynow.html?invoiceid=${hit.id}&collectionid=$collectionid"
                                     class="btn btn-xs btn-primary">[[Pay Now]]</a>
                                 #if ($hit.paymentstatusreason != "")
                                     <div class="alert alert-danger">$hit.paymentstatusreason</div>
                                 #end
		#end
                                   
                               </td>
                           </tr>
                       #end
                   </table>
               </div>
           #end
 </div>
 </div>
 