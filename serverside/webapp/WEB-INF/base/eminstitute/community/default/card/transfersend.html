<div class="send-money-form">
  <h2>Send Money</h2>

  <!-- QR Code Scanner Section -->
  <div class="qr-scanner-section">
    <label for="qrInput">Scan QR Code to get recipient address:</label>
    <input
      type="file"
      accept="image/*"
      capture="environment"
      id="qrInput"
    >
    <p id="scanResult"></p>
  </div>

  <canvas id="canvas" hidden></canvas>

  <!-- Send Money Form -->
  <form id="sendMoneyForm">
    <div class="form-group">
      <label for="recipientName">Recipient Name:</label>
      <input
        type="text"
        id="recipientName"
        name="recipientName"
        disabled
        required
      >
    </div>

	<input
	  type="hidden"
	  id="recipientUrl"
	  name="recipientUrl"
	>

    <div class="form-group">
      <label for="amount">Amount:</label>
      <input
        type="number"
        id="amount"
        name="amount"
        min="0.01"
        step="0.01"
        placeholder="0.00"
        required
      >
    </div>

    <div class="form-group">
      <label for="memo">Memo (optional):</label>
      <input
        type="text"
        id="memo"
        name="memo"
        placeholder="What's this for?"
      >
    </div>

    <div class="form-group">
      <label for="securityCode">Security Code:</label>
      <input
        type="text"
        id="securityCode"
        name="securityCode"
        maxlength="3"
        placeholder="3-digit code"
        required
      >
    </div>

    <button type="submit" id="sendButton">Send Money</button>
  </form>

  <p id="formResult"></p>
</div>

<style>
  .send-money-form {
    max-width: 400px;
    margin: 0 auto;
    padding: 20px;
  }
  .qr-scanner-section {
    margin-bottom: 20px;
    padding: 15px;
    border: 1px dashed #ccc;
    border-radius: 8px;
    background: #f9f9f9;
  }
  .form-group {
    margin-bottom: 15px;
  }
  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }
  .form-group input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  #sendButton {
    width: 100%;
    padding: 12px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
  }
  #sendButton:hover {
    background-color: #45a049;
  }
  #scanResult {
    color: #2196F3;
    font-weight: bold;
  }
  .scan-status-loading {
    color: #FF9800;
  }
  .scan-status-success {
    color: #4CAF50;
  }
  .scan-status-error {
    color: #f44336;
  }
  .scan-status-info {
    color: #2196F3;
  }
  #formResult {
    margin-top: 15px;
    padding: 10px;
    border-radius: 4px;
  }
  .success {
    background-color: #dff0d8;
    color: #3c763d;
  }
  .error {
    background-color: #f2dede;
    color: #a94442;
  }
</style>

<script src="jsQR.js"></script>
<script>
  const qrInput = document.getElementById("qrInput");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const scanResult = document.getElementById("scanResult");
  const recipientName = document.getElementById("recipientName");
  const sendMoneyForm = document.getElementById("sendMoneyForm");
  const formResult = document.getElementById("formResult");

  // Function to look up screen name from URL via REST API
  function findscreenname(linkid) {
    $.ajax({
      url: './api/screenname.json',
      type: 'GET',
      dataType: 'json',
      data: { "l": linkid },
      success: function(response) {
        if (response && response.screenname) {
          recipientName.value = response.screenname;
          scanResult.textContent = "‚úì Recipient found: " + response.screenname;
        } else {
          scanResult.textContent = "‚úó Could not find recipient for this address.";
        }
      },
      error: function(xhr, status, error) {
        console.error("Error looking up screen name:", error);
        scanResult.textContent = "‚úó Error looking up recipient. Please enter manually.";
      }
    });
  }

  // Helper function to try scanning with different image processing options
  function tryDecodeQR(imageData, width, height) {
    // Try with default options first
    let qrCode = jsQR(imageData, width, height, {
      inversionAttempts: "dontInvert"
    });
    if (qrCode) return qrCode;

    // Try with inverted colors (for dark backgrounds)
    qrCode = jsQR(imageData, width, height, {
      inversionAttempts: "onlyInvert"
    });
    if (qrCode) return qrCode;

    // Try with both inversion attempts
    qrCode = jsQR(imageData, width, height, {
      inversionAttempts: "attemptBoth"
    });
    return qrCode;
  }

  // Helper function to scale and process image for better QR detection
  function processImageAtScale(img, scale) {
    const scaledWidth = Math.round(img.width * scale);
    const scaledHeight = Math.round(img.height * scale);
    
    canvas.width = scaledWidth;
    canvas.height = scaledHeight;
    
    // Use better image smoothing for downscaling
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(img, 0, 0, scaledWidth, scaledHeight);
    
    const imageData = ctx.getImageData(0, 0, scaledWidth, scaledHeight);
    return tryDecodeQR(imageData.data, scaledWidth, scaledHeight);
  }

  // Helper function to apply contrast enhancement
  function enhanceContrast(imageData) {
    const data = imageData.data;
    const factor = 1.5; // Contrast factor
    
    for (let i = 0; i < data.length; i += 4) {
      // Convert to grayscale first
      const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
      // Apply contrast
      const enhanced = Math.min(255, Math.max(0, ((gray - 128) * factor) + 128));
      data[i] = enhanced;     // R
      data[i + 1] = enhanced; // G
      data[i + 2] = enhanced; // B
    }
    return imageData;
  }

  // Helper function to update status with optional styling
  function updateStatus(message, type = 'info') {
    scanResult.textContent = message;
    scanResult.className = 'scan-status-' + type;
  }

  // QR Code Scanner
  qrInput.addEventListener("change", () => {
    const file = qrInput.files[0];
    if (!file) return;

    updateStatus("üì§ Uploading image...", "loading");

    const img = new Image();
    
    img.onerror = () => {
      updateStatus("‚úó Failed to load image. Please try a different file.", "error");
    };

    img.onload = async () => {
      var qrCode = null;
      
      // Helper to allow UI to repaint
      var yieldToUI = function() {
        return new Promise(function(resolve) {
          requestAnimationFrame(function() {
            setTimeout(resolve, 10);
          });
        });
      };
      
      // Resize large images first for faster processing
      var maxDim = 2000;
      var imgWidth = img.width;
      var imgHeight = img.height;
      
      if (imgWidth > maxDim || imgHeight > maxDim) {
        var ratio = Math.min(maxDim / imgWidth, maxDim / imgHeight);
        imgWidth = Math.round(imgWidth * ratio);
        imgHeight = Math.round(imgHeight * ratio);
        updateStatus("üìê Resizing large image...", "loading");
        await yieldToUI();
      }
      
      // Draw resized image once
      canvas.width = imgWidth;
      canvas.height = imgHeight;
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, 0, 0, imgWidth, imgHeight);
      
      updateStatus("üîç Scanning for QR code...", "loading");
      await yieldToUI();
      
      // Try scanning the resized image
      try {
        var imageData = ctx.getImageData(0, 0, imgWidth, imgHeight);
        qrCode = tryDecodeQR(imageData.data, imgWidth, imgHeight);
      } catch (e) {
        console.error("Error scanning:", e);
      }
      
      // If not found, try smaller scales
      if (!qrCode) {
        var scales = [0.75, 0.5, 0.25];
        
        for (var i = 0; i < scales.length; i++) {
          var scale = scales[i];
          updateStatus("üîç Scanning (scale " + Math.round(scale * 100) + "%)...", "loading");
          await yieldToUI();
          
          var w = Math.round(imgWidth * scale);
          var h = Math.round(imgHeight * scale);
          canvas.width = w;
          canvas.height = h;
          ctx.drawImage(img, 0, 0, w, h);
          
          try {
            var scaledData = ctx.getImageData(0, 0, w, h);
            qrCode = tryDecodeQR(scaledData.data, w, h);
            if (qrCode) break;
          } catch (e) {
            console.error("Error at scale " + scale + ":", e);
          }
        }
      }
      
      // If still not found, try with contrast enhancement
      if (!qrCode) {
        updateStatus("üîß Enhancing image contrast...", "loading");
        await yieldToUI();
        
        canvas.width = imgWidth;
        canvas.height = imgHeight;
        ctx.drawImage(img, 0, 0, imgWidth, imgHeight);
        
        try {
          var contrastData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          contrastData = enhanceContrast(contrastData);
          qrCode = tryDecodeQR(contrastData.data, canvas.width, canvas.height);
        } catch (e) {
          console.error("Error with contrast enhancement:", e);
        }
      }

      if (qrCode) {
        updateStatus("‚úì QR Code detected! Looking up recipient...", "success");
        
        var recipientUrl = document.getElementById("recipientUrl");
        recipientUrl.value = qrCode.data;
        
        // Use REST to get the name of the person
        try {
          var url = new URL(qrCode.data);
          var linkid = url.searchParams.get('l');
          findscreenname(linkid);
        } catch (e) {
          updateStatus("‚úó Invalid QR code data format.", "error");
        }
		
      } else {
        updateStatus("‚úó No QR code detected. Try a clearer image or better lighting.", "error");
      }
    };

    img.src = URL.createObjectURL(file);
  });

  // Form Submission
  sendMoneyForm.addEventListener("submit", (e) => {
    e.preventDefault();

    const formData = {
      recipientName: recipientName.value,
      amount: document.getElementById("amount").value,
      memo: document.getElementById("memo").value,
      securityCode: document.getElementById("securityCode").value
    };

    // TODO: Replace with actual API call
    console.log("Sending money:", formData);

    formResult.textContent = "Processing transaction...";
    formResult.className = "";

    // Simulated API call - replace with actual implementation
    setTimeout(() => {
      formResult.textContent = "Transaction submitted successfully!";
      formResult.className = "success";
    }, 1000);
  });
</script>