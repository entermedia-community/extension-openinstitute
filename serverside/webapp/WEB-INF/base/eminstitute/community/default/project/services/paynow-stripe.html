    <div class=" donatecard cardpaymentcontainer">
            <form action="${projectlink}/services/payfinish.html" 
            		method="post" 
            		id="paymentform"
            		class="form  "
            		data-targetdiv="collectivecheckout"
            		data-oemaxlevel="1">
                <input type="hidden" name="collectionid" value="$!librarycol.id" />
                
                 #if ($customer.sources.data.size() > 0)
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label>[[Card Options]]:</label>
                    	<select id="selectedsource" class="form-control" name="selectedsource">
                    		<option value="">New Credit Card</option>
                    		#foreach ($s in $customer.sources.data)
                        		<option value="$s.id">$s.brand (****-$s.last4)</option>
                        		#set( $custsource = $s.id )
                    		#end
                    	</select>
                	</div>
                </div>
				#end  
				<div id="allcreditcardform" class="creditcardform">	
				
                    <div class="d-flex justify-content-between mb-1">
							<div>
								<label for="staticEmail">[[Card Info]]:</label>
							</div>
                            <div>
								<img src="${communitylink}/theme/icons/creditcard.png" style="margin-top:-10px;" />
						    </div>
                     </div>
							
					<div class="form-group">
						<div class="form-control">
                            <div id="card-element" style="width: 100%"></div>
						</div>
                    </div>
				</div>

                <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="staticEmail">[[Amount]]:</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">$</div>
                                    </div>
                                    <input type="text" class="form-control" name="totalprice.value"
                                        id="totalprice" #if($invoice.totalprice) value="$invoice.totalprice"
                                        disabled #end>
                                </div>
                            </div>
                        </div>

                	  	<div class="col-md-12">
                        	<div class="form-check">
                                <input type="checkbox" class="form-check-input" id="issavecard" name="issavecard"></input>
                                <label class="form-check-label" style="font-size: 0.8rem;" for="issavecard">[[Save this Credit Card for future payments]]</label>	
                            </div>
                       	</div>
                	   
                    </div>
				
                <div class="row mt-2">                            	
                    <div class="col-md-8">
                    <div id="card-errors" class="donateformerror" role="alert"></div>
                        <div class="donate-secure ">
                            <i class="fa-solidfa-lock"></i> [[Secure payment]]
                        </div>
                    </div>
                    <div class="col-md-4 text-right">
                        <div style=" margin: 0px auto;">
                            <a href="#" class="btn btn-success btn-paynow submitform" id="paynowbtn">
								<i class="fa-solidfa-credit-card"></i> [[Pay Now]] </a>
                        </div>
                    </div>
                </div>
				
				<input type="hidden" name="isautopaid" id="isautopaid" value="$lastproduct.isautopaid" />
				<input type="hidden" name="savestripecreditcard" id="savestripecreditcard" value="true" />
				<input type="hidden" name="recurring" value="$lastproduct.recurring" />
                <input type="hidden" name="field" value="collectionid" /> 
                <input type="hidden" name="collectionid.value" value="$!librarycol.getId()" /> 
                <input type="hidden" name="collectionid" value="$!librarycol.getId()" />
                <input type="hidden" name="invoiceid" value="$id" /> 
                <input type="hidden" name="field" value="totalprice" /> 
                <input type="hidden" name="field" value="userid" /> 
                <input type="hidden" name="userid.value" value="$!user.getId()" />
				<input type="hidden" name="stripetokenid" id="stripetokenid" />
				<input type="hidden" name="stripenewsource" id="stripenewsource" />
                <input type="text" name="stripecustomer" id="stripecustomer" value="$!{customer.id}" hidden="" />
				$context.putSessionValue("payinginvoice", $id)
            </form>

</div>


<script type="text/javascript">
	$("#issavecard").change(function() {  
	    if ($(this).is(":checked")) {
	    	document.getElementById('savestripecreditcard').value = true;
	    } else {
	    	document.getElementById('savestripecreditcard').value = false;
	    }
	});
	document.getElementById('issavecard').checked = true;
		
    $(document).ready(function () {
		 
		#if ($customer.sources.data.size() > 0) 
			$("#selectedsource").change(function() { 
				var selected = $("#selectedsource").val();
				if (selected != "") { 
					$("#allcreditcardform").attr('hidden', true);
				} 
				else {
					$("#allcreditcardform").attr('hidden', false);
				}
			}); 
		#end  
		
		#set($stripepublishkey = $paymentprocessor.getPublicApiKey())
		 
		var stripe = null;
		#ifnotnull($stripepublishkey)
		   stripe = Stripe("${stripepublishkey}");
		   var elements = stripe.elements();
	       var style = { base: { fontSize: '18px', color: "#495057" } };
	       var card = elements.create('card', { style: style });
	       card.mount('#card-element');
	       card.addEventListener('change', function (event) {
	           var displayError = document.getElementById('card-errors');
	           if (event.error) {
	               $(displayError).html('<div class="errormsg">' + event.error.message + '</div>');
	           } else {
	               displayError.textContent = '';
	           }
	       });
		#end

        var form = $("#paymentform");
		var readytosubmit = false;
        $(form).validate({
            rules: {
                "totalprice.value": {
                    required: true,
                    number: true
                }
            },
            submitHandler: function (form) {
				#ifnotnull($stripepublishkey)
	            	var selectedsource = $("#selectedsource").val();
					$("#paynowbtn").removeClass("submitform");
					$(".cardpaymentcontainer").css("cursor", "wait");
					
	            	if (selectedsource === undefined || selectedsource == "") {
		                stripe.createToken(card).then(function (result) {
		                    if (result.error) {
		                        var errorElement = document.getElementById('card-errors');
		                        $(errorElement).html('<div class="errormsg">' + result.error.message + '</div>');
								$(".cardpaymentcontainer").css("cursor", "default");
								$("#paynowbtn").addClass("submitform");
		                    } else {
								$("#stripetokenid").val(result.token.id);
								$("#stripenewsource").val(result.token.card.id);
								readytosubmit = true;
		                    }
	                	});
	            	} else {
						readytosubmit = true;
	            	}
					if (readytosubmit) 
					{
						var targetdiv = $("#" + $(form).data("targetdiv"));
						var toastUid = $(form).data("uid");
						$(form).ajaxSubmit({
							success: function (result) {
								$(window).trigger("successToast", [toastUid]);
								targetdiv.replaceWith(result);
							},
							error: function () {
								$(window).trigger("errorToast", [toastUid]);
							},
						});
					}
				#end
            },
            errorElement: "div",
            errorClass: "errormsg",
            errorPlacement: function (error, element) {
                error.appendTo(element.closest(".form-group").parent());
                //$("#card-errors").html('<div class="errormsg">'+error.html()+'</div>');
            }
        });


    });
</script>