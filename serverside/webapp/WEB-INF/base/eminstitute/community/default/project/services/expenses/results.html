#set( $showreimburst = $context.getRequestParameter("showreimburst"))
<div id="expensereport">
	<div id="emresultscontent">
	<div id="resultsdiv">  
     	<div class="emdata emdatatable">
            #set($hits = $expenses)
			$context.putPageValue("hits",$hits)
			
			#set($sortedby= $hits.getSortBy())
			
			#if( !$hits.isEmpty() ) 
				#set($resultsLink = "${projectlink}/services/expenses/results.html?hitssessionid=$hits.sessionId&oemaxlevel=1&collectiveexpensesortby=$!sortedby&pageposition")
				$context.putPageValue("resultsLink",$resultsLink)
	            $pages.include("${communityhome}/components/table/pages.html", $context)
			#end
                  
              <table class="table table-striped table-hover">
                  <thead>
                      <tr class="tableheader">
                          #if($showcollections )
                          	<th>[[Collection]]</th>
                          #end
						  
						  <th>[[Date]] #if($sortedby.startsWith("date")) #if($sortedby.endsWith("Down")) <i class="fas fa-arrow-down"></i> #else <i class="fas fa-arrow-up"></i>  #end #end</th>
                           <th>[[Account]] #if($sortedby.startsWith("bankaccount")) #if($sortedby.endsWith("Down")) <i class="fas fa-arrow-down"></i> #else <i class="fas fa-arrow-up"></i>  #end #end</th>
                           <th>[[Type]] #if($sortedby.startsWith("incometype")) #if($sortedby.endsWith("Down")) <i class="fas fa-arrow-down"></i> #else <i class="fas fa-arrow-up"></i>  #end #end</th>
                           <th>[[Description]] #if($sortedby.startsWith("incomedescription")) #if($sortedby.endsWith("Down")) <i class="fas fa-arrow-down"></i> #else <i class="fas fa-arrow-up"></i>  #end #end</th>
						   <th>[[Paid]] #if($sortedby.startsWith("ispaid")) #if($sortedby.endsWith("Down")) <i class="fas fa-arrow-down"></i> #else <i class="fas fa-arrow-up"></i>  #end #end</th>
						   <th>[[Total]] #if($sortedby.startsWith("total")) #if($sortedby.endsWith("Down")) <i class="fas fa-arrow-down"></i> #else <i class="fas fa-arrow-up"></i>  #end #end</th>
                          <th></th>
                      </tr>
                  </thead>
				  
				  <tbody>
                  #foreach($hit in $hits.getPageOfHits())
                      <tr>
                          #if($showcollections )
						  
						 	#set( $project= $!mediaarchive.getCachedData("librarycollection", $hit.collectionid) )
		  					#set( $community = $mediaarchive.getCachedData("communitytagcategory",$project.communitytagcategory))
		  					#if($project.urlname)
		  						#set($projectlink = "$!{community.externaldomain}/${project.urlname}/goals/priorities")
		  					#else
		  						#set($projectlink = "${communitylink}/proposal/${project.id}/#dash($project.getName()).html")
		  					#end
											
                          <td>
							#ifnotnull($project)
							<a
                                href="$!{projectlink}/services/expenses/index.html?collectionid=$hit.collectionid"
                                class=""
                                target="_new"income
                                data-hidefooter="true"
                                >
                                  $!project
                             </a>
							 #end
                          </td>
                          #end
                          <td>$!context.getDate($hit.date)</td>
                          <td>$!mediaarchive.getCachedData("bankaccount", $hit.paidfromaccount)</td>
                          <td>$!context.getText($!mediaarchive.getCachedData("expensetype", $hit.expensetype))</td>
                          <td>#esc($hit.expensedescription)</td>
                          <td>#if( $hit.getValue("ispaid") ) [[paid on ]] $!context.getDate($hit.paymentdate) #end</td>								  
                          <td style="text-align: right; width:140px;">$!context.doubleToMoney($!hit.total, 2) $!context.getText($!mediaarchive.getCachedData("currencytype", $hit.currencytype) )</td>
	                      <td style="text-align: center; min-width:70px;">
	                            #if( $caneditcollection || $showcollections)
	                                <a
	                                #if( $showreimburst )
	                                	#set(  $baselink = "${projectlink}/services/reimbursements")
	                                    href="$baselink/expenseedit.html?id=$hit.id&searchtype=collectiveexpense&collectionid=$hit.collectionid&librarycol=$hit.collectionid"
	                                #else
	                                	#set(  $baselink = "${projectlink}/services/expenses")
	                                    href="$baselink/edit.html?id=$hit.id&searchtype=collectiveexpense&collectionid=$hit.collectionid&librarycol=$hit.collectionid"
	                                #end
	                                    class="btn btn-xs btn-warning emdialog"
	                                    data-hidefooter="true"
	                                    title="[[Edit Expense]]  $!mediaarchive.getCachedData("librarycollection", $hit.collectionid)"
	                                    ><i class="fa fa-edit"></i></a>

	                                <a
	                                    href="${projectlink}/services/expenses/move/move.html?id=$hit.id&searchtype=collectiveexpense&collectionid=$hit.collectionid"
	                                    class="btn btn-xs btn-secondary emdialog"
	                                    title="[[Move Expense]]  $!mediaarchive.getCachedData("librarycollection", $hit.collectionid)"
	                                    ><i class="fa fa-angle-right"></i></a>
	                                    
	                            #end
	                      </td>
	                    </tr>
	                #end
	                </tbody>
                
                ##Totals moved down
				<tfoot>
					#if($pendingexpensesreimburseuser_total)
						#foreach($userid in $pendingexpensesreimburseuser_total.keySet())
			                	<tr>
			                		#if($showcollections )<td></td>#end
			                		<td></td>
			                		<td></td>
		                			#set($subtotal = $pendingexpensesreimburseuser_total.get($userid))
			                		<td class="text-left" style="width:150px">$!mediaarchive.getUser( $userid )</td>
			                		<td class="text-right">
			                			$!context.doubleToMoney($subtotal, 2)
			                		</td>
			                		<td></td>
			                		<td></td>
			                		<td></td>
		                		</tr>
						#end  
					#end
	                #if($totalsbycurrency)
						#set($ustotal = 0)
		                #if($totalsbycurrency)
		                	#foreach( $currency in $totalsbycurrency.keySet())
								#set($subtotal = $totalsbycurrency.get($currency))
			                	<tr class="table-row-subtotals">
									#if($showcollections )<td></td>#end
			                		<td colspan="3"></td>
			                		<td class="text-right">[[Sub Total]]:</td>
			                		<td class="text-right">
			       
										#set( $convertedtotal = $financeManager.inDollars($currency,$subtotal))
										#ifnotnull($convertedtotal)
											#set($ustotal = $mathutil.addition($ustotal, $convertedtotal) )
										#end
										
										#if ($currency != "1")
											$!context.doubleToMoney($!subtotal, 2) $!context.getText($!mediaarchive.getCachedData("currencytype", $currency))
										#end 
										
			                		</td>
			                		<td class="text-right">
										$!context.doubleToMoney($!convertedtotal, 2) $!context.getText($!mediaarchive.getCachedData("currencytype", "1"))
									</td>
									<td></td>
			                	</tr>
		                	#end
						
							<tr class="table-row-totals">
								#if($showcollections )<td></td>#end
		                		<td colspan="4"></td>
		                		<td class="text-right"><strong>[[Total]]:</strong></td>
		                		<td class="text-right">
		                			<strong>$!context.doubleToMoney($!ustotal, 2) $!context.getText($!mediaarchive.getCachedData("currencytype", "1"))</strong> 
		                		</td>
		                		<td></td>
		                	</tr>
						#end
							
							
			     	
			     #end  
				 </tfoot>
                
                
                
            </table>
            
        </div>
       
       #if($canviewsettings && $expenses.size() > 0)
        <div>
	        <a href="${projectlink}/services/expenses/export/expenses.csv?collectionid=$!{librarycol.id}&hitssessionid=$expenses.getSessionId()"
	           class="btn btn-sm btn-primary mb-4">[[Download CSV]]</a>
	           
	        <a href="${projectlink}/services/expenses/import/index.html?collectionid=$!{librarycol.id}"
	           class="btn btn-sm btn-primary mb-4 emdialog" title="[[Import Expenes]]">[[Import CSV]]</a>
          </div>
		#end
        #if( $canviewsettings  && $expenses.size() > 0)
	        <div>
	        <a class="ajax btn btn-sm btn-secondary" 
	        data-targetdiv="expensereport" 
	        data-collectionid="$librarycol.id" 
	        data-confirm="[[Sure you want to delete all] $expenses.size() [[records?]]" 
	        href="${projectlink}/services/expenses/deleteall.html" 
	        data-hitssessionid="$!expenses.getSessionId()">[[Delete]] $expenses.size()</a>
	        </div>
        #end

      </div>  
	  </div>
</div>